name: Liquibase Migration Change Notification

on:
  push:
    branches:
      - main
    paths:
      - '**/db/**/*.xml'

jobs:
  send-migration-notification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -E "db/.*\.xml$" || true)
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "files=" >> $GITHUB_OUTPUT # Set an empty output if no files changed
          else
            echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          fi
          echo "::group::List of changed files"
          echo "$CHANGED_FILES"
          echo "::endgroup::"

      - name: Send Slack notification
        if: steps.changed-files.outputs.files != ''
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: '#database-migrations'
          SLACK_USERNAME: 'DB Migration Bot'
          SLACK_COLOR: '#008080' 
          SLACK_ICON: https://github.com/liquibase/liquibase/raw/master/liquibase-core/src/main/resources/liquibase/liquibase.png
          SLACK_TITLE: ' Database Migration Changes'
          SLACK_MESSAGE: "*List of changed Liquibase files:*\n${{ steps.changed-files.outputs.files }}\nCommit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" 
          MSG_MINIMAL: true